<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>以setTimeout来聊聊Event Loop | 咸鱼老弟</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">以setTimeout来聊聊Event Loop</h1><a id="logo" href="/.">咸鱼老弟</a><p class="description">【博客园-咸鱼老弟】</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/resource/"><i class="fa fa-university"> 资源</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">以setTimeout来聊聊Event Loop</h1><div class="post-meta">Feb 26, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、setTimeout基本用法"><span class="toc-number">1.</span> <span class="toc-text">1、setTimeout基本用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Event-Loop简介"><span class="toc-number">2.</span> <span class="toc-text">2、Event Loop简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是Event-Loop呢？"><span class="toc-number">2.0.1.</span> <span class="toc-text">什么是Event Loop呢？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、理解js代码的执行"><span class="toc-number">3.</span> <span class="toc-text">3、理解js代码的执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、setTimeout问题的解答"><span class="toc-number">4.</span> <span class="toc-text">4、setTimeout问题的解答</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、关于setTimeout新的问题"><span class="toc-number">5.</span> <span class="toc-text">5、关于setTimeout新的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="post-content"><blockquote>
<p>平时的工作中，也许你会经常用到setTimeout这个方法，可是你真的了解setTimeout吗？本文想通过总结setTimeout的用法，顺便来探索javascript里面的事件执行机制。</p>
</blockquote>
<a id="more"></a>
<h2 id="1、setTimeout基本用法"><a href="#1、setTimeout基本用法" class="headerlink" title="1、setTimeout基本用法"></a>1、setTimeout基本用法</h2><hr>
<p>1、<code>setTimeout(code,millisec)</code><br>　　setTimeout函数接受两个参数，第一个参数code是将要推迟执行的函数名或者一段代码，第二个参数millisec是推迟执行的毫秒数。<br>例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="string">'console.log(2)'</span>,<span class="number">100</span>);</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="number">2</span>)&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p>　　如果直接在setTimeout中直接执行代码， 需要以字符串的形式去写，引擎内部会将字符串转为可执行的代码</p>
<p>2、再来一些简单些的代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">setTimeout(<span class="string">'console.log(2)'</span>,<span class="number">1000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>);</span><br></pre></td></tr></table></figure></p>
<p>是的，如你所愿，依次输出的是  <code>// 1 3 2</code></p>
<p>3、代码升级版<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p>这个时候的输入顺序是怎样的呢？这里先埋个伏笔，因为我们是以setTimeout来聊Event Loop</p>
<h2 id="2、Event-Loop简介"><a href="#2、Event-Loop简介" class="headerlink" title="2、Event Loop简介"></a>2、Event Loop简介</h2><hr>
<h4 id="什么是Event-Loop呢？"><a href="#什么是Event-Loop呢？" class="headerlink" title="什么是Event Loop呢？"></a>什么是Event Loop呢？</h4><p>&ensp;&ensp;&ensp;&ensp;因为javascript是单线程的，所谓的单线程是指在JS引擎中负责解释和执行JavaScript代码的线程只有一个，可以叫它为主线程。<br>&ensp;&ensp;&ensp;&ensp;除了主线程，还存在其他的线程。例如：处理AJAX请求的线程、处理DOM事件的线程、定时器线程、读写文件的线程(例如在Node.js中)等等。我们以setTimeout为例，当在代码中调用setTimeout()方法时，注册的延时方法会交由浏览器内核其他模块（以webkit为例，是webcore模块）处理，当延时方法到达触发条件，即到达设置的延时时间时，这一延时方法被添加至任务队列里。这一过程由浏览器内核其他模块处理，与执行引擎主线程独立，执行引擎在主线程方法执行完毕，到达空闲状态时，会从任务队列中顺序获取任务来执行，这一过程是一个不断循环的过程，称为事件循环模型。<br><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170226101214523-381417596.png" alt=""><br>　　Javascript执行引擎的主线程运行的时候，产生堆（heap）和栈（stack）。程序中代码依次进入栈中等待执行，当调用setTimeout()方法时，即图中右侧WebAPIs方法时，浏览器内核相应模块开始延时方法的处理，当延时方法到达触发条件时，方法被添加到用于回调的任务队列，只有执行引擎栈中的代码执行完毕，主线程才会去读取任务队列，依次执行那些满足触发条件的回调函数。<br>　　在上图中的callback queue中指的是 “任务队列”，也可以理解为消息的队列，“消息“我们可以简单理解为是：注册异步任务时添加的回调函数。</p>
<p>例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(‘hello’);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;&ensp;&ensp;其中里面的function(){console.log(‘hello’)}就是一个消息，任务队列里面保存的就是这些回调函数</p>
<h2 id="3、理解js代码的执行"><a href="#3、理解js代码的执行" class="headerlink" title="3、理解js代码的执行"></a>3、理解js代码的执行</h2><hr>
<p>我们以一段代码的运行来进行理解，代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Timer1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'hello'</span>);</span><br><span class="line">&#125;,<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Timer2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'world'</span>);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>);</span><br></pre></td></tr></table></figure></p>
<p>代码运行的gif图如下：<br><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170226112523241-1162148115.gif" alt=""></p>
<p>我们分步骤来进行这个过程解答<br>　　 1、js执行引擎开始执行上述代码时，会先讲一个main()方法加入执行栈。首先第一个console.log(‘start’)入栈，console.log方法是一个webkit内核支持的普通方法，而不是前面图中WebAPIs涉及的方法，所以这里log(‘start’)方法立即出栈被引擎执行。<br>　　2、引擎继续往下，将setTimeout(callback,200)添加到执行栈。setTimeout()方法属于事件循环模型中WebAPIs中的方法，引擎在将setTimeout()方法出栈执行时，将延时执行的函数交给了相应模块，即图右方的timer模块来处理。<br>　　3、然后主线程继续向下执行，紧接着将第二个定时器也交给Timer模块，然后执行到第二个console.log()，控制台打印’end’，<br>　　4、执行完毕后清空执行栈。但是并没有结束，在主线程执行的同时，Timer模块会检查其中的异步代码，一旦满足触发条件，就会将它添加到任务队列中。Timer2延迟100ms，所以会早于Timer1被添加到队列排头。而主线程此时处于空闲状态，所以会检查任务队列是否有待执行的任务。此时会将Timer2回调中的console.log()执行，控制台打印’world’，然后执行栈空闲后继续检查任务队列，将Timer1的代码压入执行栈中执行，控制台打印’hello’，清空执行栈，此时任务队列为空，执行结束,程序处理完毕，main()方法也出栈。<br>　　5、在这里再次强调一下，不是setTimeout加入了事件队列，而是setTimeout里面的回调函数加入了事件队列</p>
<h2 id="4、setTimeout问题的解答"><a href="#4、setTimeout问题的解答" class="headerlink" title="4、setTimeout问题的解答"></a>4、setTimeout问题的解答</h2><hr>
<p>回到我们文章之初的那倒题：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br><span class="line"><span class="comment">//Time2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Time3</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p>如果理解了上面的内容，那么这道题理解起来就比较容易了。<br>　　首先是打印出 1，然后是10000个4，那么Time1、Time2、Time3是顺序是如何的呢？<br>　　在这个代码中，for循环比较耗时，在Time1和Timer加入到执行队列中后，主线程依然还在执行for循环中的代码，处于阻塞状态。队列中的Time1和Time2并不会得以执行。当for循环结束，这时才将Time3交由Timer模块去管理，清空执行栈。虽然在这里Time3的延迟时间最短，但是加入任务队列后还是会排在Time1和Time2的后面，所以此时按顺序执行任务队列中的代码，依次打印2、3、5。<br>所以执行结果为：<br><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170226131730320-9660993.jpg" alt=""></p>
<h2 id="5、关于setTimeout新的问题"><a href="#5、关于setTimeout新的问题" class="headerlink" title="5、关于setTimeout新的问题"></a>5、关于setTimeout新的问题</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br><span class="line"><span class="comment">//Time2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Time3</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>　　上面这个问题中，Time3加入任务队列的时间比Time2,Time1晚，所以它是最后才执行的。那么问题来了，请看下面代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Time2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">10000</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Time3</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;,<span class="number">100</span>);</span><br></pre></td></tr></table></figure></p>
<p>&ensp;&ensp;&ensp;&ensp;我们将Time1和Time2的顺序对换一下，按照前面的说法，Time2先加入任务队列，然后是Time1，再然后是Time3。可是执行的结果还是1、4、2、3、5，这是为什么呢？虽然Time1的执行时间短，可是它比Time2晚加入任务队列啊。<br>&ensp;&ensp;&ensp;&ensp;为了验证这个问题，我们可以提出这样的一个假设：<br><code>如果setTimeout加入队列的阻塞时间大于两个setTimeout执行的间隔时间，那么先加入任务队列的先执行，尽管它里面设置的时间比另一个setTimeout的要大</code></p>
<p>可能假设听起来比较拗口，我们可以用代码来理解一下：</p>
<p><strong>代码1：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Time2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> start=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">5000</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'这里只是模拟一个耗时操作'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> end=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'阻塞耗时：'</span>+<span class="built_in">Number</span>(end-start)+<span class="string">'毫秒'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br></pre></td></tr></table></figure>
<p>Time1比Time2设定的执行时间早100ms，但是Time2先加入任务队列，在Time2和Time1时间有一个阻塞的for循环，执行结果如下：</p>
<p><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170227132406766-1770219106.png" alt=""></p>
<p>Time2先执行；</p>
<p><strong>代码2：</strong><br>我们把for循环里面的时间设置短一点：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> start=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">500</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'这里只是模拟一个耗时操作'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> end=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'阻塞耗时：'</span>+<span class="built_in">Number</span>(end-start)+<span class="string">'毫秒'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br></pre></td></tr></table></figure>
<p><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170227132754095-1066713665.png" alt=""></p>
<p>此时，Time1先执行，因为阻塞的耗时小于Time1和Time2的执行间隔时间100毫秒；<br></p>
<p><strong>代码3：</strong><br>我们再来验证一下，把Time2的执行时间设为350毫秒；<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Time2</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;,<span class="number">350</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> start=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">500</span>;i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'这里只是模拟一个耗时操作'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> end=<span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'阻塞耗时：'</span>+<span class="built_in">Number</span>(end-start)+<span class="string">'毫秒'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Time1</span></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;,<span class="number">300</span>);</span><br></pre></td></tr></table></figure></p>
<p>直接结果为：<br><img src="//images2015.cnblogs.com/blog/776370/201702/776370-20170227133015141-186210832.png" alt=""><br>Time2先执行，因为阻塞的时间大于两个setTimeout之间的间隔时间。</p>
<p>　　通过上面的假设，我们可以得出这样一个结论：<strong>如果setTimeout加入队列的阻塞时间大于两个setTimeout执行的间隔时间，那么先加入任务队列的先执行，尽管它里面设置的时间可能比另一个setTimeout的要大</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p> 　　理解js的事件循环在平时的工作中还是挺有用的，它可以让我们清楚的知道事件的执行顺序，知道事件的走向，才能更好的驾驭Javascript。本文是对事件循环的一个小小总结，更多的干货，可以看看下面的参考文档。本文有误之处，欢迎指出<br><br></p>
<p>参考文档：</p>
<p><a href="//www.alloyteam.com/2015/10/turning-to-javascript-series-from-settimeout-said-the-event-loop-model/">【转向Javascript系列】从setTimeout说事件循环模型</a><br><a href="//www.ruanyifeng.com/blog/2014/10/event-loop.html">JavaScript 运行机制详解：再谈Event Loop</a><br><a href="https://segmentfault.com/a/1190000004322358" target="_blank" rel="noopener">JavaScript：彻底理解同步、异步和事件循环(Event Loop)</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://xianyulaodi.github.io/2017/02/26/以setTimeout来聊聊Event Loop/" data-id="cje8p101s000wjkp6llltsszi" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACrklEQVR42u3aQW7kQAgFUN//0sk20sTtDxSdHul5FTlOVT0vDAGuK76+flw/79w98++Td7+trnBtXHh4eHiDo/c2uPttdYXeeR5eHB4eHt4aL9myunThEMFreh2Wbu/j4eHhfRgvSYiTNXtpOh4eHt7/wkvArwsH1ZCTnAcPDw/v/bx86eTQp4oRyZ1jtRY8PDy8Wh3gyo/+CT+v9Pfw8PDwxl31vERbLUb0xgLKp8XDw8Nb4FXT5Tlpo2320ELDw8PDezuvWqrotbgmJYmHffHw8PCWeYXGUvGZydjWKB3Hw8PDW+P1RqyqowB54MkbbIX+Hh4eHt6Yd6DpHqfLeYGjF5ZGG+Dh4eENBgLyxHeeCp8qRtyuj4eHh/cWXqGxNEi4qyl78z4eHh7eAm/elJoUbaOPe7EkgYeHh7fNqya++ehAguk1zwohDQ8PD2+Bl3yCkw90UpjIh7cmr/IXER4eHt4ar4rJixS9Am6vh9Xss+Hh4eEVeflHvBoGqulyb5Sh8Fd4eHh4h3hJaaDXjurBqvs+rIOHh4d3lNcbsaoOafWKCL318fDw8N7D6w0E9D7f1VLvFV94eHh4f8ubBIxJAaI3HHB7fjw8PLwF3uTzXcXkL+VwQw4PDw9vgddrL1XT6L3BglE6joeHh9fi5Q2wKi9Pf+eJ++2+eHh4eGu8PMGtUk+FirxA/EtgwMPDw1vjVQ9dzdaTRDkJMIUSBh4eHt5R3ql0dl6ubY5VvX5xeHh4eAu83khTteV/qiBbXQcPDw9vjzcpN5xKtZPEujfWgIeHh7fHywsHk3CyMTj18CQeHh7eB/DydleveJGPICQBAw8PD+8TeL0ENy8u9EYEHoau8PDw8BZ4efMp/9xPUuTDgQEPDw/vKK/6D3/exMoLvpN9D1x4eHh4Ke8by3UiFkZQ7dwAAAAASUVORK5CYII=" class="article-share-link">分享</a><div class="tags"><a href="/tags/博客园迁移/">博客园迁移</a><a href="/tags/setTimeout/">setTimeout</a><a href="/tags/Eventloop/">Eventloop</a></div><div class="post-nav"><a href="/2017/03/12/cookie小结/" class="pre">cookie小结</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'xianyulaodi',
  repo: 'myBlogCommentRepo',
  oauth: {
    client_id: 'bb8f1145bdd0717d9830',
    client_secret: 'b18dc8d3b04cea043cb47d083049276cd93e0503',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://xianyulaodi.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/高阶函数/" style="font-size: 15px;">高阶函数</a> <a href="/tags/BigPipe/" style="font-size: 15px;">BigPipe</a> <a href="/tags/博客园迁移/" style="font-size: 15px;">博客园迁移</a> <a href="/tags/cookie/" style="font-size: 15px;">cookie</a> <a href="/tags/expess/" style="font-size: 15px;">expess</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/path/" style="font-size: 15px;">path</a> <a href="/tags/mongoose/" style="font-size: 15px;">mongoose</a> <a href="/tags/fs/" style="font-size: 15px;">fs</a> <a href="/tags/setTimeout/" style="font-size: 15px;">setTimeout</a> <a href="/tags/Eventloop/" style="font-size: 15px;">Eventloop</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/vuex/" style="font-size: 15px;">vuex</a> <a href="/tags/vue-router/" style="font-size: 15px;">vue-router</a> <a href="/tags/router/" style="font-size: 15px;">router</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a> <a href="/tags/爬虫/" style="font-size: 15px;">爬虫</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/02/25/如何写一个npm包/">如何写一个npm包</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/02/10/BigPipe小探/">BigPipe小探</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/22/将中文转为拼音首字母/">js提取中文拼音首字母</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/29/给女朋友写的一个简书爬虫/">给女朋友写的一个简书爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/24/nodejs学习小结/">nodejs学习小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/express图片上传/">express图片上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/19/浅析css中的cursor/">浅析css中的cursor</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/javascript高阶函数/">javascript高阶函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/18/手写一个router/">手写一个router</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/正则表达式学习/">正则表达式学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-money"> 请博主喝咖啡</i><img src="/img/WeChatQR.png"/></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.cnblogs.com/xianyulaodi/" title="我的博客园" target="_blank">我的博客园</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">咸鱼老弟.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>